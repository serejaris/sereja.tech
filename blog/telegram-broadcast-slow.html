<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Как я отправил 717 сообщений за 8 минут | Сережа Рис</title>

  <!-- SEO -->
  <meta name="description" content="Почему синхронный код для Telegram рассылки работает в 16 раз медленнее asyncio. Реальный кейс: 8 минут вместо 30 секунд на 717 получателей.">
  <meta name="author" content="Сережа Рис">
  <meta name="keywords" content="Telegram Bot API, asyncio, aiohttp, rate limiting, broadcast, рассылка, python">
  <link rel="canonical" href="https://sereja.tech/blog/telegram-broadcast-slow">

  <!-- Open Graph -->
  <meta property="og:title" content="Как я отправил 717 сообщений за 8 минут">
  <meta property="og:description" content="Почему синхронный код для Telegram рассылки работает в 16 раз медленнее asyncio.">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="ru_RU">
  <meta property="og:url" content="https://sereja.tech/blog/telegram-broadcast-slow">
  <meta property="og:site_name" content="Сережа Рис">
  <meta property="article:author" content="Сережа Рис">
  <meta property="article:published_time" content="2026-01-13T00:00:00+00:00">
  <meta property="article:section" content="Python">
  <meta property="article:tag" content="Telegram">
  <meta property="article:tag" content="Python">
  <meta property="article:tag" content="asyncio">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Как я отправил 717 сообщений за 8 минут">
  <meta name="twitter:description" content="Почему синхронный код для Telegram рассылки работает в 16 раз медленнее asyncio.">
  <meta name="twitter:creator" content="@riiiiiiiiss">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Как я отправил 717 сообщений за 8 минут (и почему это плохо)",
    "description": "Почему синхронный код для Telegram рассылки работает в 16 раз медленнее asyncio.",
    "author": {
      "@type": "Person",
      "name": "Сережа Рис",
      "url": "https://sereja.tech"
    },
    "publisher": {
      "@type": "Person",
      "name": "Сережа Рис",
      "url": "https://sereja.tech"
    },
    "datePublished": "2026-01-13",
    "dateModified": "2026-01-13",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://sereja.tech/blog/telegram-broadcast-slow"
    },
    "wordCount": 450,
    "articleSection": "Python",
    "keywords": ["Telegram Bot API", "asyncio", "aiohttp", "rate limiting", "broadcast"],
    "inLanguage": "ru-RU"
  }
  </script>

  <link href="https://unpkg.com/prismjs@1.29.0/themes/prism.css" rel="stylesheet">
  <style>
    body {
      font-family: monospace;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background: #fff;
      color: #000;
    }
    a { color: #0000EE; text-decoration: underline; }
    a:visited { color: #551A8B; }
    h1 { font-size: 24px; margin-bottom: 8px; line-height: 1.3; }
    h2 { font-size: 18px; margin-top: 30px; margin-bottom: 10px; }
    p { margin-bottom: 15px; }
    .author { color: #666; font-size: 13px; margin-bottom: 24px; }
    .intro { color: #666; margin-bottom: 8px; }
    .intro:last-of-type { margin-bottom: 24px; }

    /* Code blocks */
    .code-block {
      margin: 24px 0;
      border: 2px solid #000;
    }
    .code-block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #000;
      color: #fff;
      padding: 8px 12px;
      font-size: 12px;
    }
    .code-block-title { font-weight: normal; }
    .copy-btn {
      background: transparent;
      border: 1px solid #666;
      color: #fff;
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
      font-family: monospace;
    }
    .copy-btn:hover { background: #333; }
    .code-block pre {
      margin: 0;
      border: none;
      background: #f8f8f8;
      padding: 16px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    pre {
      background: #f8f8f8;
      border: 2px solid #000;
      padding: 16px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
      margin: 24px 0;
    }
    code { font-family: monospace; background: #eee; padding: 1px 4px; }
    pre code { background: none; padding: 0; }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
    th { background: #f5f5f5; }

    ul, ol { margin: 12px 0; padding: 0 0 0 1.2em; }
    li { margin-bottom: 4px; }

    .sources { margin-top: 40px; padding-top: 20px; border-top: 1px solid #000; }
    .sources h3 { font-size: 14px; margin-bottom: 8px; }
    .sources ul { list-style: none; padding: 0; }
    .sources li { margin-bottom: 4px; }

    footer { margin-top: 30px; text-align: center; font-size: 13px; color: #666; }
  </style>
</head>
<body>
  <p><a href="/blog/">&larr; Блог</a></p>
  <article>
    <h1>Как я отправил 717 сообщений за 8 минут</h1>
    <p class="author">Сережа Рис · 13 января 2026</p>

    <p class="intro">Запустил рассылку в Telegram-боте. 717 получателей.</p>
    <p class="intro">Смотрю на прогресс — обновляется каждые 25 сообщений. Медленно.</p>
    <p class="intro">8 минут на то, что должно было занять полминуты.</p>

    <h2>Код, который делал это</h2>

    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-title">broadcast.py</span>
        <button class="copy-btn" onclick="copyCode(this)">copy</button>
      </div>
      <pre><code class="language-python">for user in users:
    resp = requests.post(API_URL, json=payload)

    if (i + 1) % 25 == 0:
        time.sleep(1)</code></pre>
    </div>

    <p>Синхронный запрос — ждём ответа — следующий запрос. Пауза каждые 25, "чтобы не получить 429".</p>

    <p>Число 25 я выбрал произвольно. Показалось безопасным. На 50 получателях работало нормально. На 717 — нет.</p>

    <h2>Цифры</h2>

    <p>Telegram Bot API позволяет ~30 сообщений в секунду при отправке в разные чаты.</p>

    <p>717 ÷ 30 = 24 секунды. С буфером на сеть — 30-40 секунд.</p>

    <p>Мой код делал так:</p>
    <ul>
      <li>29 пауз по секунде (717 ÷ 25)</li>
      <li>requests.post блокирует на 100-300мс каждый раз</li>
      <li>Итого: 487 секунд</li>
    </ul>

    <p>Разница в 16 раз.</p>

    <h2>Как надо</h2>

    <div class="code-block">
      <div class="code-block-header">
        <span class="code-block-title">broadcast_async.py</span>
        <button class="copy-btn" onclick="copyCode(this)">copy</button>
      </div>
      <pre><code class="language-python">async def send_batch(users, message, batch_size=30):
    async with aiohttp.ClientSession() as session:
        for i in range(0, len(users), batch_size):
            batch = users[i:i+batch_size]
            tasks = [send_one(session, u, message) for u in batch]
            await asyncio.gather(*tasks)
            await asyncio.sleep(1)</code></pre>
    </div>

    <p><code>asyncio.gather</code> отправляет 30 запросов параллельно. Один батч в секунду. 717 ÷ 30 = 24 батча = 24 секунды.</p>

    <h2>Реальный результат</h2>

    <p>Итог рассылки:</p>
    <ul>
      <li>576 доставлено</li>
      <li>141 заблокировали бота</li>
      <li>80% доставляемость</li>
    </ul>

    <p>Норма для Telegram. Но ждать 8 минут ради этого — не норма.</p>

    <h2>Если получил 429</h2>

    <p>Telegram возвращает <code>retry_after</code> — сколько секунд ждать:</p>

    <pre><code class="language-python">if error_code == 429:
    retry_after = data['parameters']['retry_after']
    await asyncio.sleep(retry_after)</code></pre>

    <p>python-telegram-bot имеет встроенный AIORateLimiter. aiogram тоже. Своё писать не надо.</p>

    <h2>Итог</h2>

    <table>
      <tr>
        <th>Подход</th>
        <th>Время</th>
      </tr>
      <tr>
        <td>Синхронный requests</td>
        <td>~8 минут</td>
      </tr>
      <tr>
        <td>asyncio + aiohttp</td>
        <td>~30 секунд</td>
      </tr>
    </table>

    <p>Синхронный код проще писать. Но на 700+ получателях разница раздражает. Переписывать надо было раньше — когда аудитория была 100 человек, а не 700.</p>

    <div class="sources">
      <h3>Источники</h3>
      <ul>
        <li><a href="https://github.com/python-telegram-bot/python-telegram-bot/wiki/Avoiding-flood-limits" target="_blank">Avoiding flood limits</a> — wiki python-telegram-bot</li>
        <li><a href="https://docs.python-telegram-bot.org/en/v22.5/telegram.ext.aioratelimiter.html" target="_blank">AIORateLimiter</a> — документация</li>
        <li><a href="https://telegramhpc.com/news/574" target="_blank">Fixing 429 Errors</a> — retry policies</li>
        <li><a href="https://core.telegram.org/bots/faq" target="_blank">Bots FAQ</a> — официальная документация Telegram</li>
      </ul>
    </div>

    <footer>
      Январь 2026
    </footer>
  </article>
  <script>
  function copyCode(btn) {
    const code = btn.closest('.code-block').querySelector('code').textContent;
    navigator.clipboard.writeText(code).then(() => {
      btn.textContent = 'copied!';
      setTimeout(() => btn.textContent = 'copy', 1500);
    });
  }
  </script>
  <script src="https://unpkg.com/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://unpkg.com/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
